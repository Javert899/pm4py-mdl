<html>
<head>
    <script style="text/javascript" src="../static/jquery.min.js"></script>
    <script style="text/javascript" src="../static/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../static/bootstrap.min.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
      <div class="col-2" style="background-color: red;">
          <div>
              <h4>Process: {{Process.name}}</h4>
          </div>
          <div>
              <h4>Events: {{Process.dataframe_length}}</h4>
          </div>
      </div>
      <div class="col-10">
          <div id="svgWithInnerHtml">

          </div>
      </div>
    </div>
</div>
<script type="text/javascript">
    var cobject = null;

    function decode_utf8(s) {
      return decodeURIComponent(escape(s));
    }

    function getCObject() {
        cobject = JSON.parse(atob('{{ Process.cobject }}'));
    }

    function fillMainView() {
        var pview = atob('{{ Process.model_view }}');
        document.getElementById("svgWithInnerHtml").innerHTML = pview;
        document.getElementById("svgWithInnerHtml").addEventListener("click", click_listener);
    }

    function applyFloatFilter(activity, attr_name) {
        let min_value = parseFloat(window.prompt("Insert the minimum float value allowed for activity="+activity+" and attr_name="+attr_name, "0"));
        let max_value = parseFloat(window.prompt("Insert the maximum float value allowed for activity="+activity+" and attr_name="+attr_name, "1000000000"));
        $.ajax({url: "/applyFloatFilter?activity="+activity+"&attr_name="+attr_name+"&min_value="+min_value+"&max_value="+max_value+"&process="+window.location.pathname.split("/").pop()}).done(function() { window.location.reload(); });
    }

    function applyObjTypesFilter(activity, ot) {
        let min_value = parseFloat(window.prompt("Insert the minimum number of related objects allowed for activity="+activity+" and otype="+ot, "0"));
        let max_value = parseFloat(window.prompt("Insert the minimum number of related objects allowed for activity="+activity+" and otype="+ot, "1000000000"));
        $.ajax({url: "/applyObjTypesFilter?activity="+activity+"&ot="+ot+"&min_value="+min_value+"&max_value="+max_value+"&process="+window.location.pathname.split("/").pop()});
    }

    function click_listener(event) {
        document.getElementById("dropDown").style.display = 'none';
        if (event.target.nodeName == "text") {
            let thisText = event.target.innerHTML;
             if (thisText.length > 0) {
                thisText = removeAfterLastSpace(thisText);
                var i = 0;
                while (i < cobject['activities'].length) {
                    if (thisText === cobject['activities'][i]) {
                        document.getElementById("dropDown").innerHTML = ""
                        var x = document.createElement("div");
                        x.innerHTML = "<b>Available filters</b>:<br />"
                        document.getElementById("dropDown").appendChild(x);
                        var j = 0;
                        while (j < cobject['attr_types'][cobject['activities'][i]].length) {
                            var attr_name = cobject['attr_types'][cobject['activities'][i]][j][0];
                            var attr_type = cobject['attr_types'][cobject['activities'][i]][j][1];
                            if (attr_type.startsWith("float")) {
                                var x = document.createElement("div");
                                x.innerHTML = "<a href=\"javascript:applyFloatFilter('"+cobject['activities'][i]+"', '"+attr_name+"')\">Float filter - "+attr_name+"<a>"
                                document.getElementById("dropDown").appendChild(x);
                            }
                            j = j + 1;
                        }
                        var j = 0;
                        while (j < cobject['obj_types'][cobject['activities'][i]].length) {
                            var ot = cobject['obj_types'][cobject['activities'][i]][j];
                            var x = document.createElement("div");
                            x.innerHTML = "<a href=\"javascript:applyObjTypesFilter('"+cobject['activities'][i]+"', '"+ot+"')\">Object Type Filter - "+ot+"<a>"
                            document.getElementById("dropDown").appendChild(x);
                            j = j + 1;
                        }
                        document.getElementById("dropDown").style.display = '';
                        document.getElementById("dropDown").style.left = event.clientX+"px";
                        document.getElementById("dropDown").style.top = event.clientY+"px";
                    }
                    i++;
                }
             }
        }
    }

    function removeAfterLastSpace(oldString) {
        let newString = "";
        let oldStringSplit = oldString.split(" ");
        if (oldStringSplit.length > 0 && oldStringSplit[oldStringSplit.length - 1].length > 0 && oldStringSplit[oldStringSplit.length - 1][0] == '(') {
            let i = 0;
            while (i < oldStringSplit.length - 1) {
                newString = newString + oldStringSplit[i];
                if (i < (oldStringSplit.length - 2)) {
                    newString = newString + " ";
                }
                i++;
            }
            return newString;
        }
        return oldString;
    }

    getCObject();
    fillMainView();
</script>
<div id="dropDown" style="display: none; position: fixed; z-index: 10; background-color: #CCCCCC;">
</div>
</body>
</html>

